{% extends 'gs/home.html' %}
{% load staticfiles %}
{% load static %}
{% load leaflet_tags %}

{% block main %}
<div class="container">

    <h3>{{context.feed_download_status}}</h3>

    <div class="col-xs-3">
        <a class="btn btn-primary" href="osm/">Load Openstreetmap Data </a>
        <br><br>
        <a class="btn btn-primary" href="stops/">Get Stops </a>
        <br><br>
        <a class="btn btn-primary" href="route_masters/">Get route_master relations</a>
        <br><br>
        <a class="btn btn-primary" href="#">Get route relations</a>
    </div>

    <div class="col-xs-9">
        {% leaflet_map "osmmap" callback="loadmapfunction"%}
    </div>
</div>

<script type="text/javascript">

    function loadmapfunction(map, options) {

        //get the latest form

        latest_form_id ={{context.form_id}};

        formdata = "/gtfs/formdata/" + latest_form_id + "/";
        var feed_id;

        $.ajax({
            url:formdata,
            type:'GET',
            dataType:'json',
            async:false,
            success: function(data){
                feed_id = data.feed;
            }

        });


        var mapLayer;
        var markerArray = [];
        var nodedata = '{% url "stopdata" %}';

        $.getJSON(nodedata, function (data) {

            var lon, lat;
            var coordinates_arr = [];
            var length = data.features.length;
            for (var i = 0; i < length; i++) {
                if(data.features[i].properties.feed == feed_id) {
                    lon = data.features[i].geometry.coordinates[1];
                    lat = data.features[i].geometry.coordinates[0];
                    coordinates_arr = [lon, lat];
                    var marker = L.marker(coordinates_arr);
                    marker.addTo(map);
                    markerArray.push(marker);
                }
            }
            console.log(markerArray);
            var group = new L.featureGroup(markerArray);
            map.fitBounds(group.getBounds());
        })
    }
</script>

{% endblock %}
