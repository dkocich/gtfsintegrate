{% extends 'gs/home.html' %}
{% load staticfiles %}
{% load static %}
{% load leaflet_tags %}

{% block map %}
<div id="loading">
<img id="loading-image" src='http://i.stack.imgur.com/FhHRx.gif' alt="Loading..." />
</div>
<br><br>
<div class="dropdown">
  <button onclick="myFunction()" class="dropbtn">Dropdown</button>
  <div id="myDropdown" class="dropdown-content">
    <a href="#">Link 1</a>
    <a href="#">Link 2</a>
    <a href="#">Link 3</a>
  </div>
</div>


<div class="container">
    <div class="row widgets">
        <div class="col-md-6">
            <div class="mr-2">
                <div id="info-div">
                    <div class="information-box">
                        <h3>{{context.feed_download_status}}</h3>
                        <h3>{{context.error}}</h3>
                        <h3>{{context.connection_error}}</h3>
                        <br><br>
                        <a class="btn btn-primary"  href="stops/">Get Stops </a>
                        <br><br>
                        <a class="btn btn-primary" href="route_masters/">Get route_master relations</a>
                        <br><br>
                        <a class="btn btn-primary" href="#">Get route relations</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="ml-2">
                <div class="map-box">
                    <div id="map">{% leaflet_map "osmmap" callback="loadmapfunction"%}</div>
                </div>
            </div>
        </div>
    </div>
</div>
<!--
<div class="row">
    <div class="col-xs-6">
        <br><br><br><br>
        <h3>{{context.feed_download_status}}</h3>
        <h3>{{context.error}}</h3>
        <h3>{{context.connection_error}}
        <br><br>
        <a class="btn btn-primary"  href="stops/">Get Stops </a>
        <br><br>
        <a class="btn btn-primary" href="route_masters/">Get route_master relations</a>
        <br><br>
        <a class="btn btn-primary" href="#">Get route relations</a>
    </div>

    <div id="map-holder">
  <div class=" col-xs-6">
    <div id="map">{% leaflet_map "osmmap" callback="loadmapfunction"%}
    </div>
  </div>
</div>
</div>
</div>
-->
<script type="text/javascript">

    window.onload = function(){ document.getElementById("loading").style.display = "none" }

/* When the user clicks on the button, 
toggle between hiding and showing the dropdown content */
function myFunction() {
    document.getElementById("myDropdown").classList.toggle("show");
}

// Close the dropdown menu if the user clicks outside of it
window.onclick = function(event) {
  if (!event.target.matches('.dropbtn')) {

    var dropdowns = document.getElementsByClassName("dropdown-content");
    var i;
    for (i = 0; i < dropdowns.length; i++) {
      var openDropdown = dropdowns[i];
      if (openDropdown.classList.contains('show')) {
        openDropdown.classList.remove('show');
      }
    }
  }
}
    var feed_bounds;
    function loadmapfunction(map, options){

        feed_id = {{context.feed_id}}
        console.log(feed_id)
        var mapLayer;
        var markerArray = [];
        var gtfsstopsdata = '{% url "stopdata" %}';

        $.ajaxSetup({
            async: false
        });

        $.getJSON(gtfsstopsdata, function (data) {

            var lon, lat;
            var coordinates_arr = [];
            var length = data.features.length;
            for (var i = 0; i < length; i++) {
                if (data.features[i].properties.feed == feed_id) {
                    name = data.features[i].properties.name
                    lon = data.features[i].geometry.coordinates[1];
                    lat = data.features[i].geometry.coordinates[0];
                    coordinates_arr = [lon, lat];
                    var marker = L.marker(coordinates_arr).bindTooltip(name+",lat="+lat+",lon="+lon,{ 
        direction: 'top'
    });

                    marker.addTo(map);
                    markerArray.push(marker);
                }
            }
            console.log(markerArray);
            var group = new L.featureGroup(markerArray);
            var bounds = group.getBounds();
            feed_bounds = bounds;
            map.fitBounds(bounds);
        });
/*
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        var csrftoken = getCookie('csrftoken');

        console.log(csrftoken);

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        console.log(feed_bounds)

        //0 = lon 1 =lat
        var east_bound = feed_bounds.getEast();
        var west_bound = feed_bounds.getWest();
        var north_bound = feed_bounds.getNorth();
        var south_bound = feed_bounds.getSouth();
        var northeast_bound = [];
        northeast_bound[0] = feed_bounds.getNorthEast().lng;
        northeast_bound[1] = feed_bounds.getNorthEast().lat;
        var northwest_bound = []
        northwest_bound[0] = feed_bounds.getNorthWest().lng;
        northwest_bound[1] = feed_bounds.getNorthWest().lat;
        var southeast_bound = [];
        southeast_bound[0] = feed_bounds.getSouthEast().lng;
        southeast_bound[1] = feed_bounds.getSouthEast().lat;
        var southwest_bound = [];
        southwest_bound[0] = feed_bounds.getSouthWest().lng;
        southwest_bound[1] = feed_bounds.getSouthWest().lat;
        var URL = "{% url 'bounds' %}";

        $.ajax({
           url:URL,
           method:'POST',
           async:false,
           data: {'east':east_bound,
               'west':west_bound,
               'north':north_bound,
               'south':south_bound,
               'northeast_lon':northeast_bound[0],
               'northeast_lat':northeast_bound[1],
               'northwest_lon':northwest_bound[0],
               'northwest_lat':northwest_bound[1],
               'southeast_lon':southeast_bound[0],
               'southeast_lat':southeast_bound[1],
               'southwest_lon':southwest_bound[0],
               'southwest_lat':southwest_bound[1],
               'csrfmiddlewaretoken': '{{ csrf_token }}'},
           success: function(data){
                alert("OpenStreetMap Data has been loaded loading stop on the map");

           },
           error : function(xhr,status,e){
               alert("Something went wrong");
           }
        });


        var nodedata = '{% url "osmnodedata" %}' ;

        $.getJSON(nodedata, function(data){

            var greenIcon = new L.Icon({
              iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
              shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
              shadowSize: [41, 41]
            });
            var lon, lat;
            var coordinates_arr = [];
            var length = data.features.length;
            for (var i = 0; i < length; i++) {
                    node_id=data.features[i].properties.id
                    lon = data.features[i].geometry.coordinates[1];
                    lat = data.features[i].geometry.coordinates[0];
                    coordinates_arr = [lon, lat];
                    var marker = L.marker(coordinates_arr, {icon:greenIcon}).bindTooltip(
                        node_id+",lat="+lat+",lon="+lon,{
                            direction:'top'
                        }
                        );

                    marker.addTo(map);

            }
        });
        */

}
</script>

{% endblock %}
